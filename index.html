<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生調位App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .grid-cell.forbidden { background-color: #fca5a5; }
        .grid-cell.selected { border: 2px solid #3b82f6; }
        .grid-cell.drag-over { background-color: #bfdbfe; }
        .student-name-list button.selected { background-color: #bfdbfe; }
        .student-name-list button.has-condition { color: #8b5cf6; }
        .assigned-seat-grid-cell.selected-seat { background-color: #60a5fa; color: white; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-100 p-4 font-sans text-gray-800 flex flex-col items-center min-h-screen">

    <div id="app-root" class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6 mb-8">
        <h1 class="text-3xl font-bold text-center text-blue-700 mb-6">學生調位App</h1>
        <div class="flex justify-center mb-6 space-x-4">
            <button id="step1-btn" class="step-btn px-6 py-2 rounded-full font-medium transition-all duration-300">步驟 1</button>
            <button id="step2-btn" class="step-btn px-6 py-2 rounded-full font-medium transition-all duration-300">步驟 2</button>
            <button id="step3-btn" class="step-btn px-6 py-2 rounded-full font-medium transition-all duration-300">步驟 3</button>
            <button id="step4-btn" class="step-btn px-6 py-2 rounded-full font-medium transition-all duration-300">步驟 4</button>
        </div>

        <div id="step-content"></div>

        <div class="mt-8 pt-6 border-t border-gray-200 space-y-4">
            <h2 class="text-2xl font-semibold text-blue-600 mb-4">資料管理</h2>
            <div class="flex flex-wrap gap-4">
                <button id="export-json-btn" class="px-6 py-2 rounded-full bg-indigo-600 text-white font-medium hover:bg-indigo-700 shadow-md">
                    匯出為 JSON
                </button>
                <button id="export-csv-btn" class="px-6 py-2 rounded-full bg-indigo-600 text-white font-medium hover:bg-indigo-700 shadow-md">
                    匯出座位表為 CSV
                </button>
                <button id="export-png-btn" class="px-6 py-2 rounded-full bg-indigo-600 text-white font-medium hover:bg-indigo-700 shadow-md">
                    匯出為圖片 (PNG)
                </button>
                <label class="px-6 py-2 rounded-full bg-gray-600 text-white font-medium hover:bg-gray-700 cursor-pointer shadow-md">
                    匯入資料
                    <input type="file" id="import-file" accept=".json,.csv" class="hidden" />
                </label>
                <button id="clear-all-data-btn" class="px-6 py-2 rounded-full bg-red-600 text-white font-medium hover:bg-red-700 shadow-md">
                    清空所有資料
                </button>
            </div>
        </div>
    </div>

    <div id="message-box" class="fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-opacity duration-300 opacity-0" style="pointer-events: none;"></div>

    <script>
        // State variables
        let currentStep = 1;
        let studentNamesInput = '';
        let students = [];
        let rows = 5;
        let cols = 5;
        let forbiddenSeats = [];
        let selectedStudentId = null;
        let seatingConditions = {};
        let seatingChart = [];
        let history = [];
        let historyIndex = -1;
        let isGenerating = false;

        const STORAGE_KEY = 'seating_app_data';

        const saveState = () => {
            const dataToSave = {
                studentNamesInput,
                students,
                rows,
                cols,
                forbiddenSeats,
                seatingConditions,
                seatingChart,
                history,
                historyIndex,
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
        };

        const loadState = () => {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    studentNamesInput = data.studentNamesInput || '';
                    students = data.students || [];
                    rows = data.rows || 5;
                    cols = data.cols || 5;
                    forbiddenSeats = data.forbiddenSeats || [];
                    seatingConditions = data.seatingConditions || {};
                    seatingChart = data.seatingChart || [];
                    history = data.history || [];
                    historyIndex = data.historyIndex || -1;
                } catch (e) {
                    console.error("Failed to load state from local storage:", e);
                    clearAllData(false);
                }
            }
        };

        const generateUniqueId = () => crypto.randomUUID();

        // DOM Elements
        const stepBtns = document.querySelectorAll('.step-btn');
        const stepContent = document.getElementById('step-content');
        const messageBox = document.getElementById('message-box');
        let messageTimeout = null;

        // Utility functions
        const showMessageBox = (message, type = 'info') => {
            if (messageTimeout) clearTimeout(messageTimeout);
            messageBox.textContent = message;
            messageBox.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-opacity duration-300 opacity-100 ${
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'success' ? 'bg-green-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            messageTimeout = setTimeout(() => {
                messageBox.className = messageBox.className.replace('opacity-100', 'opacity-0');
            }, 3000);
        };

        const addChartToHistory = (chart) => {
            const newHistory = history.slice(0, historyIndex + 1);
            history = [...newHistory, chart];
            historyIndex = history.length - 1;
            saveState();
        };

        const getStudentNameById = (id) => students.find(s => s.id === id)?.name || '未知學生';
        const getStudentCondition = (studentId) => seatingConditions[studentId] || {};
        const isForbidden = (r, c) => forbiddenSeats.some(seat => seat.row === r && seat.col === c);

        const checkPlacementValidity = (studentId, r, c, chartState, currentPlacedStudents) => {
            if (!isValidSeat(r, c) || chartState[r][c] !== null) {
                return { valid: false, conflictMessage: null, isTryConflict: false };
            }

            const conditions = getStudentCondition(studentId);
            const student = students.find(s => s.id === studentId);

            const studentById = new Map(students.map(s => [s.id, s]));

            const isValidSeat = (r, c) => r >= 0 && r < rows && c >= 0 && c < cols && !isForbidden(r, c);

            const getNeighbors = (r, c) => {
                const neighbors = [];
                const directions = [
                    [-1, 0], [1, 0], [0, -1], [0, 1],
                    [-1, -1], [-1, 1], [1, -1], [1, 1]
                ];
                for (const [dr, dc] of directions) {
                    const nr = r + dr;
                    const nc = c + dc;
                    if (isValidSeat(nr, nc)) {
                        neighbors.push({ row: nr, col: nc });
                    }
                }
                return neighbors;
            };

            const getAdjacentNeighbors = (r, c) => {
                const neighbors = [];
                const directions = [[0, -1], [0, 1]];
                for (const [dr, dc] of directions) {
                    const nr = r + dr;
                    const nc = c + dc;
                    if (isValidSeat(nr, nc)) {
                        neighbors.push({ row: nr, col: nc });
                    }
                }
                return neighbors;
            };

            const cannotSitWithConditions = conditions.cannotSitWith || [];
            for (const condition of cannotSitWithConditions) {
                const { targetId } = condition;
                const neighbors = getNeighbors(r, c);
                const conflictNeighbor = neighbors.find(n => chartState[n.row][n.col] === targetId);
                if (conflictNeighbor) {
                    return { valid: false, conflictMessage: `學生 ${student.name} 無法坐在 [${r + 1}, ${c + 1}]，因為與 ${getStudentNameById(targetId)} 有「不可同坐」條件衝突。`, isTryConflict: false };
                }
            }

            const mustSitWithConditions = conditions.mustSitWith || [];
            for (const condition of mustSitWithConditions) {
                const { targetId } = condition;
                const targetStudent = studentById.get(targetId);
                if (!targetStudent) continue;

                let foundNeighbor = false;
                const adjacentNeighbors = getAdjacentNeighbors(r, c);
                const actualNeighbor = adjacentNeighbors.find(n => chartState[n.row][n.col] === targetId);
                if (actualNeighbor) {
                    foundNeighbor = true;
                }

                if (!foundNeighbor && currentPlacedStudents.has(targetId)) {
                    return { valid: false, conflictMessage: `學生 ${student.name} 無法坐在 [${r + 1}, ${c + 1}]，因為與已放置的 ${getStudentNameById(targetId)} 有「需要同坐」條件衝突。`, isTryConflict: false };
                }
            }

            if (conditions.assignedRows && conditions.assignedRows.length > 0 && !conditions.assignedRows.includes(r)) {
                return { valid: false, conflictMessage: `學生 ${student.name} 無法坐在 [${r + 1}, ${c + 1}]，因為與「指定行」條件衝突。`, isTryConflict: false };
            }
            if (conditions.assignedCols && conditions.assignedCols.length > 0 && !conditions.assignedCols.includes(c)) {
                return { valid: false, conflictMessage: `學生 ${student.name} 無法坐在 [${r + 1}, ${c + 1}]，因為與「指定列」條件衝突。`, isTryConflict: false };
            }

            let isTryConflict = false;
            if (conditions.assignedArea) {
                let meetsAreaConstraint = false;
                const getLastValidRowInColumn = (colIndex) => {
                    let lastValidRow = -1;
                    for (let r = rows - 1; r >= 0; r--) {
                        if (!isForbidden(r, colIndex)) {
                            lastValidRow = r;
                            break;
                        }
                    }
                    return lastValidRow;
                };
                const lastValidRowsPerColumn = Array(cols).fill(null).map((_, c) => getLastValidRowInColumn(c));

                if (conditions.assignedArea === 'A') {
                    const lastRowForThisCol = lastValidRowsPerColumn[c];
                    if (r === lastRowForThisCol || c === 0 || c === 5) {
                        meetsAreaConstraint = true;
                    }
                } else if (conditions.assignedArea === 'B') {
                    if (r === 0 || r === 1 || r === 2) {
                        meetsAreaConstraint = true;
                    }
                }
                if (!meetsAreaConstraint) {
                    isTryConflict = true;
                }
            }
            return { valid: true, conflictMessage: null, isTryConflict: isTryConflict };
        };


        // Main render function
        const renderStep = () => {
            stepContent.innerHTML = '';
            stepBtns.forEach(btn => btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md'));
            stepBtns[currentStep - 1].classList.add('bg-blue-600', 'text-white', 'shadow-md');

            if (currentStep === 1) renderStep1();
            if (currentStep === 2) renderStep2();
            if (currentStep === 3) renderStep3();
            if (currentStep === 4) renderStep4();
        };

        const renderStep1 = () => {
            stepContent.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-2xl font-semibold text-blue-600 mb-4">步驟 1: 學生名單與教室設定</h2>
                    <div>
                        <label for="studentNames" class="block text-lg font-medium text-gray-700 mb-2">
                            輸入學生姓名 (每行一個姓名):
                        </label>
                        <textarea id="studentNames" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" rows="8" placeholder="例如：&#10;張小明&#10;李華&#10;陳麗"></textarea>
                        <p class="text-sm text-gray-500 mt-1">目前學生人數: <span id="student-count">0</span></p>
                    </div>
                    <div class="flex space-x-4">
                        <div class="flex-1">
                            <label for="rows" class="block text-lg font-medium text-gray-700 mb-2">教室行數:</label>
                            <input type="number" id="rows" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="${rows}" min="1" />
                        </div>
                        <div class="flex-1">
                            <label for="cols" class="block text-lg font-medium text-gray-700 mb-2">教室列數:</label>
                            <input type="number" id="cols" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="${cols}" min="1" />
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-3">設定禁選位置 (點擊格子):</h3>
                        <div id="forbidden-grid" class="grid gap-1 border border-gray-300 p-2 rounded-lg bg-gray-50"></div>
                        <p class="text-sm text-gray-500 mt-2">點擊格子以標記或取消標記為禁選位置。</p>
                    </div>
                </div>
            `;
            document.getElementById('studentNames').value = studentNamesInput;
            document.getElementById('student-count').textContent = students.length;
            document.getElementById('studentNames').addEventListener('input', handleStudentNamesChange);
            document.getElementById('rows').addEventListener('input', handleRowsChange);
            document.getElementById('cols').addEventListener('input', handleColsChange);
            renderForbiddenGrid();
        };

        const renderForbiddenGrid = () => {
            const grid = document.getElementById('forbidden-grid');
            if (!grid) return;
            grid.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
            grid.innerHTML = '';
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cell = document.createElement('div');
                    cell.className = `grid-cell w-12 h-12 flex items-center justify-center border border-gray-200 rounded-md cursor-pointer transition-colors duration-200 ${isForbidden(r, c) ? 'bg-red-300 hover:bg-red-400' : 'bg-white hover:bg-gray-100'}`;
                    cell.textContent = isForbidden(r, c) ? '禁' : `${r + 1},${c + 1}`;
                    cell.addEventListener('click', () => toggleForbiddenSeat(r, c));
                    grid.appendChild(cell);
                }
            }
        };

        const renderStep2 = () => {
            stepContent.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-2xl font-semibold text-blue-600 mb-4">步驟 2: 指定區域</h2>
                    <p class="text-gray-700 mb-4">選擇學生並將他們分配到預設區域。每個學生只能分配到一個區域。</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                            <h3 class="text-xl font-semibold text-gray-700 mb-3">區域 A (每一列的最後一個非禁選座位、列1及列6)</h3>
                            <p class="text-sm text-gray-600 mb-3">學生將被限制在每一列的最後一個非禁選座位、第1列或第6列的座位。</p>
                            <div id="area-a-list" class="max-h-60 overflow-y-auto border border-gray-200 rounded-md p-2"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                            <h3 class="text-xl font-semibold text-gray-700 mb-3">區域 B (行1、2、3)</h3>
                            <p class="text-sm text-gray-600 mb-3">學生將被限制在第1、2或3行的座位。</p>
                            <div id="area-b-list" class="max-h-60 overflow-y-auto border border-gray-200 rounded-md p-2"></div>
                        </div>
                    </div>
                </div>
            `;

            const renderAreaList = (listId, area) => {
                const list = document.getElementById(listId);
                if (!list) return;
                list.innerHTML = '';
                if (students.length === 0) {
                    list.innerHTML = `<p class="text-gray-500">請先在步驟1輸入學生姓名。</p>`;
                    return;
                }
                students.forEach(student => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center py-1';
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'rounded text-blue-600 focus:ring-blue-500';
                    input.checked = getStudentCondition(student.id).assignedArea === area;
                    input.onchange = () => handleAssignedAreaToggle(area, student.id);
                    const span = document.createElement('span');
                    span.className = 'ml-2 text-gray-700';
                    span.textContent = student.name;
                    label.appendChild(input);
                    label.appendChild(span);
                    list.appendChild(label);
                });
            };

            renderAreaList('area-a-list', 'A');
            renderAreaList('area-b-list', 'B');
        };

        const renderStep3 = () => {
            stepContent.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-2xl font-semibold text-blue-600 mb-4">步驟 3: 設定座位條件</h2>
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="w-full md:w-1/3 bg-gray-50 p-4 rounded-lg shadow-inner">
                            <h3 class="text-xl font-semibold text-gray-700 mb-3">選擇學生:</h3>
                            <div id="student-list" class="max-h-80 overflow-y-auto border border-gray-200 rounded-md p-2 student-name-list"></div>
                        </div>
                        <div class="w-full md:w-2/3 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                            <h3 id="condition-title" class="text-xl font-semibold text-gray-700 mb-4">請從左側選擇一個學生來設定條件。</h3>
                            <div id="condition-panel"></div>
                        </div>
                    </div>
                </div>
            `;
            renderStudentList();
        };

        const renderStudentList = () => {
            const list = document.getElementById('student-list');
            if (!list) return;
            list.innerHTML = '';
            if (students.length === 0) {
                list.innerHTML = `<p class="text-gray-500">請先在步驟1輸入學生姓名。</p>`;
                return;
            }
            students.forEach(student => {
                const btn = document.createElement('button');
                btn.className = `block w-full text-left px-3 py-2 rounded-md transition-colors duration-200 ${selectedStudentId === student.id ? 'bg-blue-200 font-medium' : 'hover:bg-gray-100'} ${getStudentConditionStatus(student.id) ? 'text-purple-600 font-semibold' : ''}`;
                btn.textContent = student.name;
                btn.onclick = () => handleStudentSelect(student.id);
                list.appendChild(btn);
            });
            renderConditionPanel();
        };

        const renderConditionPanel = () => {
            const title = document.getElementById('condition-title');
            const panel = document.getElementById('condition-panel');
            if (!title || !panel) return;
            if (!selectedStudentId) {
                title.textContent = '請從左側選擇一個學生來設定條件。';
                panel.innerHTML = '';
                return;
            }
            title.textContent = `為 "${getStudentNameById(selectedStudentId)}" 設定條件:`;
            const conditions = getStudentCondition(selectedStudentId);

            panel.innerHTML = `
                <div class="space-y-5">
                    <div>
                        <h4 class="text-lg font-medium text-gray-700 mb-2">不可同坐 (必須符合):</h4>
                        <div id="cannot-sit-with-list" class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto p-2 border rounded-md bg-gray-50"></div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-700 mb-2">需要同坐 (左右位置，必須符合):</h4>
                        <div id="must-sit-with-list" class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto p-2 border rounded-md bg-gray-50"></div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-700 mb-2">指定行/列 (多選，符合其中一個即可，必須符合):</h4>
                        <div id="assigned-row-list" class="flex flex-wrap gap-2 mb-2">
                            <span class="font-medium text-gray-600">行:</span>
                        </div>
                        <div id="assigned-col-list" class="flex flex-wrap gap-2">
                            <span class="font-medium text-gray-600">列:</span>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-700 mb-2">指定位置 (點擊網格選擇，必須符合):</h4>
                        <div id="assigned-seat-grid" class="grid gap-1 border border-gray-300 p-2 rounded-lg bg-gray-50"></div>
                        <p class="text-sm text-gray-500 mt-1">點擊格子以指定或取消指定座位。</p>
                    </div>
                </div>
            `;

            const renderCheckboxList = (listId, type) => {
                const list = document.getElementById(listId);
                if (!list) return;
                students.filter(s => s.id !== selectedStudentId).forEach(targetStudent => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center space-x-2';
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'rounded text-blue-600 focus:ring-blue-500';
                    const isChecked = type === 'cannot' ? isCannotSitWithSelected(targetStudent.id) : isMustSitWithSelected(targetStudent.id);
                    input.checked = isChecked;
                    input.onchange = () => type === 'cannot' ? handleCannotSitWithToggle(targetStudent.id) : handleMustSitWithToggle(targetStudent.id);
                    const label = document.createElement('label');
                    label.htmlFor = `${type}-${selectedStudentId}-${targetStudent.id}`;
                    label.className = 'text-gray-700 flex-1';
                    label.textContent = targetStudent.name;
                    div.appendChild(input);
                    div.appendChild(label);
                    list.appendChild(div);
                });
            };

            renderCheckboxList('cannot-sit-with-list', 'cannot');
            renderCheckboxList('must-sit-with-list', 'must');

            const renderRowColCheckboxes = (listId, count, type) => {
                const list = document.getElementById(listId);
                if (!list) return;
                for (let i = 0; i < count; i++) {
                    const label = document.createElement('label');
                    label.className = 'inline-flex items-center';
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'rounded text-blue-600 focus:ring-blue-500';
                    const isChecked = type === 'row' ? (getStudentCondition(selectedStudentId).assignedRows || []).includes(i) : (getStudentCondition(selectedStudentId).assignedCols || []).includes(i);
                    input.checked = isChecked;
                    input.onchange = () => type === 'row' ? handleAssignedRowToggle(i) : handleAssignedColToggle(i);
                    const span = document.createElement('span');
                    span.className = 'ml-1';
                    span.textContent = i + 1;
                    label.appendChild(input);
                    label.appendChild(span);
                    list.appendChild(label);
                }
            };
            renderRowColCheckboxes('assigned-row-list', rows, 'row');
            renderRowColCheckboxes('assigned-col-list', cols, 'col');

            const renderAssignedSeatGrid = () => {
                const grid = document.getElementById('assigned-seat-grid');
                if (!grid) return;
                grid.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
                grid.innerHTML = '';
                const assignedSeat = getStudentCondition(selectedStudentId).assignedSeat;
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        const cell = document.createElement('div');
                        cell.className = `assigned-seat-grid-cell w-12 h-12 flex items-center justify-center border border-gray-200 rounded-md cursor-pointer transition-colors duration-200 ${isForbidden(r, c) ? 'bg-red-300 cursor-not-allowed' : 'bg-white hover:bg-gray-100'} ${assignedSeat?.row === r && assignedSeat?.col === c ? 'selected-seat' : ''}`;
                        cell.textContent = isForbidden(r, c) ? '禁' : `${r + 1},${c + 1}`;
                        cell.addEventListener('click', () => !isForbidden(r, c) && handleAssignedSeatSelect(r, c));
                        grid.appendChild(cell);
                    }
                }
            };
            renderAssignedSeatGrid();
        };

        const renderStep4 = () => {
            stepContent.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-2xl font-semibold text-blue-600 mb-4">步驟 4: 產生座位表與手動調整</h2>
                    <button id="generate-btn" class="px-8 py-3 rounded-full font-bold text-white transition-all duration-300 shadow-md"></button>
                    <div class="flex space-x-2 mt-4">
                        <button id="undo-btn" class="px-6 py-2 rounded-full bg-yellow-500 text-white font-medium hover:bg-yellow-600 disabled:bg-gray-400 disabled:cursor-not-allowed">撤銷</button>
                        <button id="redo-btn" class="px-6 py-2 rounded-full bg-yellow-500 text-white font-medium hover:bg-yellow-600 disabled:bg-gray-400 disabled:cursor-not-allowed">重做</button>
                    </div>
                    <button id="confirm-btn" class="px-8 py-3 rounded-full font-bold text-white transition-all duration-300 shadow-md bg-purple-600 hover:bg-purple-700 active:bg-purple-800 mt-4">確認並記錄座位表</button>
                    <h3 class="text-xl font-semibold text-gray-700 mb-3 mt-6">座位網格 (可拖動調整):</h3>
                    <div id="seating-grid-container" class="grid gap-1 border border-gray-300 p-2 rounded-lg bg-gray-50 overflow-auto"></div>
                </div>
            `;
            document.getElementById('generate-btn').addEventListener('click', generateSeatingChart);
            document.getElementById('undo-btn').addEventListener('click', handleUndo);
            document.getElementById('redo-btn').addEventListener('click', handleRedo);
            document.getElementById('confirm-btn').addEventListener('click', handleConfirmSeatingChart);
            renderSeatingGrid();
        };

        const renderSeatingGrid = () => {
            const container = document.getElementById('seating-grid-container');
            if (!container) return;

            const generateBtn = document.getElementById('generate-btn');
            if(generateBtn) {
                 generateBtn.textContent = isGenerating ? '正在生成...' : '自動產生座位表';
                 generateBtn.disabled = isGenerating || students.length === 0;
                 if (!isGenerating && students.length > 0) {
                     generateBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                 } else {
                     generateBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                     generateBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                 }
            }


            if (seatingChart.length > 0) {
                container.style.gridTemplateColumns = `repeat(${cols}, minmax(100px, 1fr))`;
                container.style.minWidth = `${cols * 100}px`;
                container.innerHTML = '';
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        const studentIdInSeat = seatingChart[r][c];
                        const studentNameInSeat = studentIdInSeat ? getStudentNameById(studentIdInSeat) : '';
                        const isCurrentSelected = selectedStudentId === studentIdInSeat;
                        const selectedStudentConditions = selectedStudentId ? getStudentCondition(selectedStudentId) : {};

                        let highlightColor = '';
                        if (selectedStudentId && studentIdInSeat) {
                            if (selectedStudentConditions.cannotSitWith?.some(cs => cs.targetId === studentIdInSeat)) highlightColor = 'bg-red-200';
                            if (selectedStudentConditions.mustSitWith?.some(ms => ms.targetId === studentIdInSeat)) highlightColor = 'bg-green-200';
                            const studentInSeatConditions = getStudentCondition(studentIdInSeat);
                            if (studentInSeatConditions.cannotSitWith?.some(cs => cs.targetId === selectedStudentId)) highlightColor = 'bg-red-200';
                            if (studentInSeatConditions.mustSitWith?.some(ms => ms.targetId === selectedStudentId)) highlightColor = 'bg-green-200';
                        }

                        const cell = document.createElement('div');
                        cell.className = `grid-cell w-full h-24 flex flex-col items-center justify-center border border-gray-200 rounded-md transition-colors duration-200 text-center p-1 ${isForbidden(r, c) ? 'bg-red-300' : 'bg-white hover:bg-gray-100'} ${isCurrentSelected ? 'border-2 border-blue-500 bg-blue-100' : ''} ${highlightColor}`;
                        cell.innerHTML = `
                            <span class="text-xs text-gray-500 mb-1">${r + 1},${c + 1}</span>
                            ${studentIdInSeat ? `<div draggable="true" class="w-full bg-blue-500 text-white text-sm font-medium py-1 px-2 rounded-md cursor-grab active:cursor-grabbing shadow-sm hover:bg-blue-600">${studentNameInSeat}</div>` : ''}
                        `;
                        cell.addEventListener('dragover', (e) => e.preventDefault());
                        cell.addEventListener('drop', (e) => handleDrop(e, r, c));
                        cell.addEventListener('click', () => handleStudentSelect(studentIdInSeat));
                        if (studentIdInSeat) {
                            cell.querySelector('div').addEventListener('dragstart', (e) => handleDragStart(e, studentIdInSeat));
                        }
                        container.appendChild(cell);
                    }
                }
            } else {
                 if (students.length > 0) {
                     container.innerHTML = `<p class="text-gray-500 mt-4">請點擊「自動產生座位表」來生成初始座位表。</p>`;
                 } else {
                     container.innerHTML = `<p class="text-gray-500 mt-4">請先在步驟1輸入學生姓名。</p>`;
                 }
            }
        };

        // Event handlers
        const handleStudentNamesChange = (e) => {
            studentNamesInput = e.target.value;
            const names = e.target.value.split('\n').map(name => name.trim()).filter(name => name !== '');
            const newStudents = names.map(name => {
                const existingStudent = students.find(s => s.name === name);
                return existingStudent || { id: generateUniqueId(), name: name };
            });
            students = newStudents;
            document.getElementById('student-count').textContent = students.length;
            saveState();
        };

        const handleRowsChange = (e) => {
            const value = parseInt(e.target.value, 10);
            rows = isNaN(value) || value < 1 ? 1 : value;
            renderForbiddenGrid();
            saveState();
        };

        const handleColsChange = (e) => {
            const value = parseInt(e.target.value, 10);
            cols = isNaN(value) || value < 1 ? 1 : value;
            renderForbiddenGrid();
            saveState();
        };

        const toggleForbiddenSeat = (r, c) => {
            const index = forbiddenSeats.findIndex(seat => seat.row === r && seat.col === c);
            if (index > -1) {
                forbiddenSeats = forbiddenSeats.filter(seat => !(seat.row === r && seat.col === c));
            } else {
                forbiddenSeats = [...forbiddenSeats, { row: r, col: c }];
            }
            renderForbiddenGrid();
            saveState();
        };

        const handleStudentSelect = (studentId) => {
            selectedStudentId = selectedStudentId === studentId ? null : studentId;
            if (currentStep === 3) {
                 renderStudentList(); // Re-render the student list to update highlights
            }
            if (currentStep === 4) {
                 renderSeatingGrid(); // Re-render the seating grid to update highlights
            }
        };

        const updateStudentCondition = (studentId, key, value) => {
            seatingConditions = {
                ...seatingConditions,
                [studentId]: {
                    ...seatingConditions[studentId],
                    [key]: value
                }
            };
            if (currentStep === 3) renderStudentList();
            saveState();
        };

        const handleCannotSitWithToggle = (targetId) => {
            if (!selectedStudentId) return;
            const currentConditions = getStudentCondition(selectedStudentId);
            let cannotSitWith = currentConditions.cannotSitWith || [];
            const existingIndex = cannotSitWith.findIndex(item => item.targetId === targetId);
            if (existingIndex > -1) {
                cannotSitWith = cannotSitWith.filter(item => item.targetId !== targetId);
            } else {
                cannotSitWith = [...cannotSitWith, { targetId, priority: '必須符合' }];
            }
            updateStudentCondition(selectedStudentId, 'cannotSitWith', cannotSitWith);
        };
        const isCannotSitWithSelected = (targetId) => {
            if (!selectedStudentId) return false;
            const conditions = getStudentCondition(selectedStudentId);
            return (conditions.cannotSitWith || []).some(cs => cs.targetId === targetId);
        };
        const handleMustSitWithToggle = (targetId) => {
            if (!selectedStudentId) return;
            const currentConditions = getStudentCondition(selectedStudentId);
            let mustSitWith = currentConditions.mustSitWith || [];
            const existingIndex = mustSitWith.findIndex(item => item.targetId === targetId);
            if (existingIndex > -1) {
                mustSitWith = mustSitWith.filter(item => item.targetId !== targetId);
            } else {
                mustSitWith = [...mustSitWith, { targetId, priority: '必須符合' }];
            }
            updateStudentCondition(selectedStudentId, 'mustSitWith', mustSitWith);
        };
        const isMustSitWithSelected = (targetId) => {
            if (!selectedStudentId) return false;
            const conditions = getStudentCondition(selectedStudentId);
            return (conditions.mustSitWith || []).some(ms => ms.targetId === targetId);
        };
        const handleAssignedRowToggle = (rowNum) => {
            if (!selectedStudentId) return;
            const conditions = getStudentCondition(selectedStudentId);
            const assignedRows = conditions.assignedRows || [];
            if (assignedRows.includes(rowNum)) {
                updateStudentCondition(selectedStudentId, 'assignedRows', assignedRows.filter(r => r !== rowNum));
            } else {
                updateStudentCondition(selectedStudentId, 'assignedRows', [...assignedRows, rowNum]);
            }
        };
        const handleAssignedColToggle = (colNum) => {
            if (!selectedStudentId) return;
            const conditions = getStudentCondition(selectedStudentId);
            const assignedCols = conditions.assignedCols || [];
            if (assignedCols.includes(colNum)) {
                updateStudentCondition(selectedStudentId, 'assignedCols', assignedCols.filter(c => c !== colNum));
            } else {
                updateStudentCondition(selectedStudentId, 'assignedCols', [...assignedCols, colNum]);
            }
        };
        const handleAssignedSeatSelect = (r, c) => {
            if (!selectedStudentId) return;
            const currentAssignedSeat = getStudentCondition(selectedStudentId).assignedSeat;
            if (currentAssignedSeat && currentAssignedSeat.row === r && currentAssignedSeat.col === c) {
                updateStudentCondition(selectedStudentId, 'assignedSeat', null);
            } else {
                updateStudentCondition(selectedStudentId, 'assignedSeat', { row: r, col: c });
            }
        };
        const handleAssignedAreaToggle = (area, studentId) => {
            const conditions = getStudentCondition(studentId);
            const currentArea = conditions.assignedArea;
            updateStudentCondition(studentId, 'assignedArea', currentArea === area ? null : area);
        };
        const getStudentConditionStatus = (studentId) => {
            const conditions = getStudentCondition(studentId);
            return Object.keys(conditions).some(key => {
                const value = conditions[key];
                if (Array.isArray(value)) return value.length > 0;
                if (typeof value === 'object' && value !== null) return Object.keys(value).length > 0;
                return value !== null && value !== undefined && value !== '';
            });
        };

        const generateSeatingChart = () => {
            isGenerating = true;
            renderSeatingGrid();
            showMessageBox("正在生成座位表，請稍候...", "info");

            const maxAttempts = 12;
            let attemptCount = 0;
            let generationSuccess = false;
            let lastConflictMessage = null;

            const studentById = new Map(students.map(s => [s.id, s]));

            const isValidSeat = (r, c) => r >= 0 && r < rows && c >= 0 && c < cols && !isForbidden(r, c);
            const getNeighbors = (r, c) => {
                const neighbors = [];
                const directions = [[-1, 0], [1, 0], [0, -1], [0, 1], [-1, -1], [-1, 1], [1, -1], [1, 1]];
                for (const [dr, dc] of directions) {
                    const nr = r + dr;
                    const nc = c + dc;
                    if (isValidSeat(nr, nc)) neighbors.push({ row: nr, col: nc });
                }
                return neighbors;
            };
            const getAdjacentNeighbors = (r, c) => {
                const neighbors = [];
                const directions = [[0, -1], [0, 1]];
                for (const [dr, dc] of directions) {
                    const nr = r + dr;
                    const nc = c + dc;
                    if (isValidSeat(nr, nc)) neighbors.push({ row: nr, col: nc });
                }
                return neighbors;
            };

            const checkPlacement = (studentId, r, c, chartState, currentPlacedStudents) => checkPlacementValidity(studentId, r, c, chartState, currentPlacedStudents);
            const getLastValidRowInColumn = (colIndex) => {
                 let lastValidRow = -1;
                 for (let r = rows - 1; r >= 0; r--) {
                     if (!isForbidden(r, colIndex)) {
                         lastValidRow = r;
                         break;
                     }
                 }
                 return lastValidRow;
            };
            const lastValidRowsPerColumn = Array(cols).fill(null).map((_, c) => getLastValidRowInColumn(c));

            while (attemptCount < maxAttempts && !generationSuccess) {
                attemptCount++;
                let currentChart = Array(rows).fill(null).map(() => Array(cols).fill(null));
                let studentsToPlace = [...students];
                let placedStudents = new Set();
                let currentAttemptSuccess = true;
                let currentAttemptConflictMessage = null;

                // Phase 1: Assigned seats
                let remainingStudentsAfterAssignedSeat = [];
                for (const student of studentsToPlace) {
                    const conditions = getStudentCondition(student.id);
                    if (conditions.assignedSeat && conditions.assignedSeat.row !== undefined && conditions.assignedSeat.col !== undefined) {
                        const { row, col } = conditions.assignedSeat;
                        if (!isValidSeat(row, col) || currentChart[row][col] !== null) {
                            currentAttemptConflictMessage = `錯誤：學生 ${student.name} 的指定座位 [${row + 1}, ${col + 1}] 有衝突。`;
                            currentAttemptSuccess = false;
                            break;
                        }
                        currentChart[row][col] = student.id;
                        placedStudents.add(student.id);
                    } else {
                        remainingStudentsAfterAssignedSeat.push(student);
                    }
                }
                if (!currentAttemptSuccess) { lastConflictMessage = currentAttemptConflictMessage; continue; }
                studentsToPlace = remainingStudentsAfterAssignedSeat;

                // Phase 2: Must sit with pairs
                const mustSitWithPairsToPlace = [];
                const studentsInMustSitWithPairs = new Set();
                studentsToPlace.forEach(student => {
                    const conditions = getStudentCondition(student.id);
                    conditions.mustSitWith?.forEach(partner => {
                        if (!studentsInMustSitWithPairs.has(student.id) && !studentsInMustSitWithPairs.has(partner.targetId)) {
                            const partnerExists = studentsToPlace.some(s => s.id === partner.targetId);
                            if (partnerExists) {
                                mustSitWithPairsToPlace.push([student.id, partner.targetId]);
                                studentsInMustSitWithPairs.add(student.id);
                                studentsInMustSitWithPairs.add(partner.targetId);
                            }
                        }
                    });
                });

                for (const pair of mustSitWithPairsToPlace) {
                    const [studentAId, studentBId] = pair;
                    if (placedStudents.has(studentAId) || placedStudents.has(studentBId)) continue;
                    let pairPlaced = false;
                    const allAvailableSeats = [];
                    for (let r = 0; r < rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            if (currentChart[r][c] === null && isValidSeat(r, c)) allAvailableSeats.push({ r, c });
                        }
                    }
                    allAvailableSeats.sort((a, b) => a.r - b.r);
                    for (let i = allAvailableSeats.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [allAvailableSeats[i], allAvailableSeats[j]] = [allAvailableSeats[j], allAvailableSeats[i]];
                    }

                    for (const { r, c } of allAvailableSeats) {
                        const { valid: validA } = checkPlacement(studentAId, r, c, currentChart, placedStudents);
                        if (!validA) continue;
                        const rB_right = r;
                        const cB_right = c + 1;
                        if (isValidSeat(rB_right, cB_right) && currentChart[rB_right][cB_right] === null) {
                            placedStudents.add(studentAId);
                            const { valid: validB_right } = checkPlacement(studentBId, rB_right, cB_right, currentChart, placedStudents);
                            placedStudents.delete(studentAId);
                            if (validB_right) {
                                currentChart[r][c] = studentAId;
                                currentChart[rB_right][cB_right] = studentBId;
                                placedStudents.add(studentAId);
                                placedStudents.add(studentBId);
                                pairPlaced = true;
                                break;
                            }
                        }
                        if (pairPlaced) break;
                        const rB_left = r;
                        const cB_left = c - 1;
                        if (isValidSeat(rB_left, cB_left) && currentChart[rB_left][cB_left] === null) {
                            placedStudents.add(studentAId);
                            const { valid: validB_left } = checkPlacement(studentBId, rB_left, cB_left, currentChart, placedStudents);
                            placedStudents.delete(studentAId);
                            if (validB_left) {
                                currentChart[r][c] = studentAId;
                                currentChart[rB_left][cB_left] = studentBId;
                                placedStudents.add(studentAId);
                                placedStudents.add(studentBId);
                                pairPlaced = true;
                                break;
                            }
                        }
                    }
                    if (!pairPlaced) {
                        currentAttemptConflictMessage = `無法為學生對找到相鄰座位。`;
                        currentAttemptSuccess = false;
                        break;
                    }
                }
                if (!currentAttemptSuccess) { lastConflictMessage = currentAttemptConflictMessage; continue; }
                studentsToPlace = studentsToPlace.filter(s => !placedStudents.has(s.id));

                // Phase 3 & 4 & 5: Remaining students
                const remainingStudentsSorted = studentsToPlace.sort((a, b) => {
                    const condA = getStudentCondition(a.id);
                    const condB = getStudentCondition(b.id);
                    let scoreA = 0; let scoreB = 0;
                    if (condA.cannotSitWith?.length > 0) scoreA += 100; if (condB.cannotSitWith?.length > 0) scoreB += 100;
                    if (condA.assignedRows?.length > 0 || condA.assignedCols?.length > 0) scoreA += 50; if (condB.assignedRows?.length > 0 || condB.assignedCols?.length > 0) scoreB += 50;
                    if (condA.assignedArea) scoreA += 1; if (condB.assignedArea) scoreB += 1;
                    return scoreB - scoreA;
                });

                for (const student of remainingStudentsSorted) {
                    if (placedStudents.has(student.id)) continue;
                    let bestSeatForStudent = null;
                    const allAvailableSeats = [];
                    for (let r = 0; r < rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            if (currentChart[r][c] === null && isValidSeat(r, c)) allAvailableSeats.push({ r, c });
                        }
                    }
                    allAvailableSeats.sort((a, b) => a.r - b.r);
                    for (let i = allAvailableSeats.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [allAvailableSeats[i], allAvailableSeats[j]] = [allAvailableSeats[j], allAvailableSeats[i]];
                    }

                    for (const { r, c } of allAvailableSeats) {
                        const { valid, isTryConflict } = checkPlacement(student.id, r, c, currentChart, placedStudents);
                        if (valid) {
                            if (!isTryConflict) {
                                bestSeatForStudent = { r, c };
                                break;
                            } else if (!bestSeatForStudent) {
                                bestSeatForStudent = { r, c };
                            }
                        }
                    }
                    if (bestSeatForStudent) {
                        currentChart[bestSeatForStudent.r][bestSeatForStudent.c] = student.id;
                        placedStudents.add(student.id);
                    } else {
                        currentAttemptConflictMessage = `無法找到滿足學生 ${getStudentNameById(student.id)} 條件的可用座位。`;
                        currentAttemptSuccess = false;
                        break;
                    }
                }
                if (!currentAttemptSuccess) { lastConflictMessage = currentAttemptConflictMessage; continue; }
                
                // Final verification
                let verificationPassed = true;
                const studentPositions = new Map();
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        if (currentChart[r][c] !== null) studentPositions.set(currentChart[r][c], { r, c });
                    }
                }
                for (const student of students) {
                    const studentId = student.id;
                    const studentPos = studentPositions.get(studentId);
                    if (!studentPos) { verificationPassed = false; break; }
                    const conditions = getStudentCondition(studentId);
                    const cannotSitWithConditions = conditions.cannotSitWith || [];
                    for (const condition of cannotSitWithConditions) {
                        const targetId = condition.targetId;
                        const targetPos = studentPositions.get(targetId);
                        if (targetPos) {
                            const neighbors = getNeighbors(studentPos.r, studentPos.c);
                            if (neighbors.some(n => currentChart[n.row][n.col] === targetId)) { verificationPassed = false; break; }
                        }
                    }
                    if (!verificationPassed) break;
                    const mustSitWithConditions = conditions.mustSitWith || [];
                    for (const condition of mustSitWithConditions) {
                        const targetId = condition.targetId;
                        const targetPos = studentPositions.get(targetId);
                        if (targetPos) {
                            const adjacentNeighbors = getAdjacentNeighbors(studentPos.r, studentPos.c);
                            if (!adjacentNeighbors.some(n => currentChart[n.row][n.col] === targetId)) { verificationPassed = false; break; }
                        } else { verificationPassed = false; break; }
                    }
                    if (!verificationPassed) break;
                    if (conditions.assignedRows && conditions.assignedRows.length > 0 && !conditions.assignedRows.includes(studentPos.r)) { verificationPassed = false; break; }
                    if (conditions.assignedCols && conditions.assignedCols.length > 0 && !conditions.assignedCols.includes(studentPos.c)) { verificationPassed = false; break; }
                    if (conditions.assignedSeat && (conditions.assignedSeat.row !== studentPos.r || conditions.assignedSeat.col !== studentPos.c)) { verificationPassed = false; break; }
                    if (isForbidden(studentPos.r, studentPos.c)) { verificationPassed = false; break; }
                }

                if (verificationPassed) {
                    generationSuccess = true;
                    seatingChart = currentChart;
                    addChartToHistory(seatingChart);
                }
            }

            isGenerating = false;
            renderSeatingGrid();
            if (generationSuccess) {
                showMessageBox("座位表生成完成！", "success");
            } else {
                showMessageBox(`座位表生成失敗，原因：${lastConflictMessage || '無法找到滿足所有條件的配置。'}。`, "error");
                seatingChart = [];
                renderSeatingGrid();
            }
        };


        const handleDragStart = (e, studentId) => e.dataTransfer.setData('studentId', studentId);
        const handleDrop = (e, targetRow, targetCol) => {
            e.preventDefault();
            const draggedStudentId = e.dataTransfer.getData('studentId');
            const newChart = JSON.parse(JSON.stringify(seatingChart));
            let sourceRow = -1; let sourceCol = -1;
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    if (newChart[r][c] === draggedStudentId) {
                        sourceRow = r; sourceCol = c; break;
                    }
                }
                if (sourceRow !== -1) break;
            }
            if (sourceRow === -1 || isForbidden(targetRow, targetCol)) return;
            const targetStudentId = newChart[targetRow][targetCol];
            newChart[targetRow][targetCol] = draggedStudentId;
            newChart[sourceRow][sourceCol] = targetStudentId;
            seatingChart = newChart;
            addChartToHistory(seatingChart);
            renderSeatingGrid();
            showMessageBox("座位已手動調整。", "info");
        };

        const handleUndo = () => {
            if (historyIndex > 0) {
                historyIndex--;
                seatingChart = history[historyIndex];
                renderSeatingGrid();
                saveState();
                showMessageBox("已撤銷一步。", "info");
            } else { showMessageBox("沒有更多可撤銷的操作。", "info"); }
        };

        const handleRedo = () => {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                seatingChart = history[historyIndex];
                renderSeatingGrid();
                saveState();
                showMessageBox("沒有更多可重做的操作。", "info");
            } else { showMessageBox("沒有更多可重做的操作。", "info"); }
        };

        const handleConfirmSeatingChart = () => {
             if (seatingChart.length === 0) {
                 showMessageBox("沒有座位表可以確認。", "info");
                 return;
             }
             showMessageBox("座位表已在本地確認。", "success");
        };

        const handleExport = (format) => {
            let dataToExport = {
                studentNamesInput,
                students,
                rows,
                cols,
                forbiddenSeats,
                seatingConditions,
                seatingChart,
            };
            let filename = 'seating_data';
            let mimeType = '';
            let content = '';

            if (format === 'json') {
                content = JSON.stringify(dataToExport, null, 2);
                mimeType = 'application/json';
                filename += '.json';
                downloadFile(content, filename, mimeType);
            } else if (format === 'csv') {
                let csvContent = "Row,Col,StudentName,StudentId\n";
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        const studentId = seatingChart[r][c];
                        const studentName = studentId ? students.find(s => s.id === studentId)?.name : '';
                        csvContent += `${r + 1},${c + 1},"${studentName}","${studentId || ''}"\n`;
                    }
                }
                content = csvContent;
                mimeType = 'text/csv';
                filename += '.csv';
                downloadFile(content, filename, mimeType);
            } else if (format === 'png') {
                const seatingGrid = document.getElementById('seating-grid-container');
                if (!seatingGrid) {
                    showMessageBox("無法找到座位網格來匯出圖片。", "error");
                    return;
                }
                html2canvas(seatingGrid, {
                    scale: 2, // Double resolution for better quality
                    useCORS: true
                }).then(canvas => {
                    const img = canvas.toDataURL("image/png");
                    const a = document.createElement('a');
                    a.href = img;
                    a.download = 'seating_chart.png';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }).catch(error => {
                    console.error("Failed to export image:", error);
                    showMessageBox("匯出圖片時發生錯誤。", "error");
                });
            }
            showMessageBox(`數據已匯出為 ${format.toUpperCase()} 格式。`, "success");
        };

        const downloadFile = (content, filename, mimeType) => {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const handleImport = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const content = event.target.result;
                    let importedData = {};
                    if (file.name.endsWith('.json')) {
                        importedData = JSON.parse(content);
                    } else if (file.name.endsWith('.csv')) {
                        const lines = content.split('\n').map(line => line.trim()).filter(line => line !== '');
                        const newStudentNames = lines.map(line => line.split(',')[2]).filter(name => name).join('\n');
                        studentNamesInput = newStudentNames;
                        const names = newStudentNames.split('\n').map(name => name.trim()).filter(name => name !== '');
                        students = names.map(name => ({ id: generateUniqueId(), name: name }));
                        showMessageBox("CSV 學生名單已匯入。", "success");
                        renderStep1();
                        return;
                    } else {
                        showMessageBox("不支援的文件格式。請匯入 .json 或 .csv 文件。", "error");
                        return;
                    }
                    if (importedData.studentNamesInput) studentNamesInput = importedData.studentNamesInput;
                    if (importedData.students) students = importedData.students;
                    if (importedData.rows) rows = importedData.rows;
                    if (importedData.cols) cols = importedData.cols;
                    if (importedData.forbiddenSeats) forbiddenSeats = importedData.forbiddenSeats;
                    if (importedData.seatingConditions) seatingConditions = importedData.seatingConditions;
                    if (importedData.seatingChart) seatingChart = importedData.seatingChart;
                    if (importedData.history) history = importedData.history;
                    if (importedData.historyIndex !== undefined) historyIndex = importedData.historyIndex;
                    saveState();
                    showMessageBox("數據已成功匯入。", "success");
                    renderStep();
                } catch (error) {
                    console.error("匯入文件時發生錯誤:", error);
                    showMessageBox("匯入文件時發生錯誤或文件格式不正確。", "error");
                }
            };
            reader.readAsText(file);
        };

        const clearAllData = (showMsg = true) => {
            studentNamesInput = '';
            students = [];
            rows = 5;
            cols = 5;
            forbiddenSeats = [];
            seatingConditions = {};
            seatingChart = [];
            history = [];
            historyIndex = -1;
            selectedStudentId = null;
            currentStep = 1;
            localStorage.removeItem(STORAGE_KEY);
            renderStep();
            if (showMsg) showMessageBox("所有本地資料已清空。", "success");
        };

        // Event listeners for step buttons
        document.getElementById('step1-btn').addEventListener('click', () => { currentStep = 1; renderStep(); });
        document.getElementById('step2-btn').addEventListener('click', () => { currentStep = 2; renderStep(); });
        document.getElementById('step3-btn').addEventListener('click', () => { currentStep = 3; renderStep(); });
        document.getElementById('step4-btn').addEventListener('click', () => { currentStep = 4; renderStep(); });
        document.getElementById('export-json-btn').addEventListener('click', () => handleExport('json'));
        document.getElementById('export-csv-btn').addEventListener('click', () => handleExport('csv'));
        document.getElementById('export-png-btn').addEventListener('click', () => handleExport('png'));
        document.getElementById('import-file').addEventListener('change', handleImport);
        document.getElementById('clear-all-data-btn').addEventListener('click', () => {
             if (window.confirm('確定要清空所有資料嗎？此操作無法撤銷。')) {
                 clearAllData();
             }
        });

        // Initial load and render
        window.onload = () => {
            loadState();
            renderStep();
        };

        // The following code is a fallback for `window.confirm`.
        // This is to ensure that the app still works if the window confirm is not available.
        window.confirm = (message) => {
            const result = window.prompt(message + "\n\n請輸入 '確定' 來繼續。");
            return result === '確定';
        };

    </script>
</body>
</html>
